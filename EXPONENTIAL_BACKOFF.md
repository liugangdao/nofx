# 幂级避让（指数退避）功能说明

## 功能概述

幂级避让是一种智能风险控制机制，当系统检测到止损触发时，会自动暂停交易一段时间。每次止损后，休息时间会呈指数增长，帮助系统在市场不利时避免连续亏损。

## 工作原理

### 触发条件

系统通过以下方式检测止损触发：

1. **开仓时记录止损价格**：每次开仓时，系统会记录AI设置的止损价格
2. **持仓消失时检查**：当持仓消失时，进行三重验证
3. **三重验证机制**：
   - ✅ 价格接近止损价（±5%容差）
   - ✅ 账户总额减少（确认是亏损）
   - ✅ 持仓已消失

**判断逻辑**：
- 多仓：当前价格 ≤ 止损价格 × 1.05 **且** 账户总额减少
- 空仓：当前价格 ≥ 止损价格 × 0.95 **且** 账户总额减少

**优点**：
- 三重验证，准确率极高
- 避免止盈误判为止损
- 适用于所有交易所
- 不依赖订单历史API
- 考虑滑点和市场波动

每次检测到止损触发后，止损计数器 +1

### 休息时间计算
休息时间 = 基础时间 × (倍数 ^ (止损次数 - 1))

**示例**（默认配置：基础45分钟，倍数2.67）：
- 第1次止损：45分钟
- 第2次止损：45 × 2.67 = 120分钟（2小时）
- 第3次止损：120 × 2.67 = 320分钟（5.3小时）
- 第4次及以后：360分钟（6小时，达到上限）

### 计数器重置
- 如果距离上次止损超过指定时间（默认24小时），计数器自动重置为0
- 重置后，下次止损将从第1次开始计算

## 配置说明

在 `config.json` 中为每个 trader 添加以下配置：

```json
{
  "traders": [
    {
      "id": "trader_1",
      "name": "My Trader",
      "enable_exponential_backoff": true,
      "backoff_base_minutes": 45,
      "backoff_multiplier": 2.67,
      "backoff_max_minutes": 360,
      "backoff_reset_hours": 24,
      ...
    }
  ]
}
```

### 配置参数

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `enable_exponential_backoff` | bool | false | 是否启用幂级避让 |
| `backoff_base_minutes` | int | 45 | 基础休息时间（分钟） |
| `backoff_multiplier` | float | 2.67 | 每次止损后的倍数 |
| `backoff_max_minutes` | int | 360 | 最大休息时间（分钟） |
| `backoff_reset_hours` | int | 24 | 重置计数器的时间（小时） |

## 使用建议

### 保守策略
适合新手或市场波动较大时：
```json
{
  "enable_exponential_backoff": true,
  "backoff_base_minutes": 60,
  "backoff_multiplier": 3.0,
  "backoff_max_minutes": 480,
  "backoff_reset_hours": 48
}
```
- 第1次：60分钟
- 第2次：180分钟（3小时）
- 第3次：480分钟（8小时，达到上限）

### 激进策略
适合经验丰富的交易者：
```json
{
  "enable_exponential_backoff": true,
  "backoff_base_minutes": 30,
  "backoff_multiplier": 2.0,
  "backoff_max_minutes": 240,
  "backoff_reset_hours": 12
}
```
- 第1次：30分钟
- 第2次：60分钟
- 第3次：120分钟（2小时）
- 第4次：240分钟（4小时，达到上限）

### 关闭功能
如果不需要此功能，设置为：
```json
{
  "enable_exponential_backoff": false
}
```

## 日志示例

启用后，系统会输出以下日志：

```
⚙️  [My Trader] 幂级避让已启用: 基础45分钟, 倍数2.67, 最大360分钟, 24小时重置
🛑 检测到止损触发（第1次）：BTCUSDT_long
   止损价: 95000.0000 | 当前价: 94800.0000 | 入场价: 96000.0000
   账户总额: 1000.00 -> 985.50 (-14.50)
⏸ 幂级避让启动：暂停交易45分钟（至15:30:00）
⏸ 幂级避让：暂停交易中（第1次止损），剩余 42 分钟
✅ 幂级避让：距离上次止损已超过24小时，重置计数器（1 -> 0）
```

## 注意事项

1. **与原有风控共存**：幂级避让与原有的 `max_daily_loss`、`max_drawdown` 等风控机制独立运行，互不影响
2. **仅检测止损**：通过价格比对判断，只有价格接近止损价时才触发（±5%容差）
3. **持仓保留**：暂停期间，现有持仓会继续保留，只是不会开新仓
4. **多trader独立**：每个trader的止损计数器独立计算
5. **容差设置**：5%的价格容差可以避免误判，同时考虑滑点和市场波动

## 适用场景

- ✅ 连续止损后需要冷静期
- ✅ 市场剧烈波动时自动减少交易频率
- ✅ 防止情绪化交易导致的连续亏损
- ✅ 给AI更多时间观察市场变化

## 不适用场景

- ❌ 高频交易策略
- ❌ 需要快速反应的套利策略
- ❌ 已有完善的外部风控系统
