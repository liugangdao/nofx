# 移动止盈和分仓止盈配置指南

## 功能概述

本系统支持两种自动止盈策略：

1. **移动止盈（Trailing Stop）**：当持仓盈利达到一定水平后，自动跟踪最高盈利点，并在回撤达到设定距离时自动平仓
2. **分仓止盈（Partial Take Profit）**：在不同盈利水平分批平仓，锁定部分利润同时保留部分仓位

## 配置参数

### 移动止盈配置

```json
{
  "enable_trailing_stop": true,
  "trailing_stop_distance": 0.03,
  "trailing_stop_activation": 0.05
}
```

**参数说明：**

- `enable_trailing_stop`：是否启用移动止盈（true/false）
- `trailing_stop_distance`：移动止盈距离，表示从峰值回撤多少时触发止盈
  - 例如：0.03 表示从最高盈利点回撤3%时平仓
  - 取值范围：0 到 1（0.01 = 1%）
- `trailing_stop_activation`：移动止盈激活条件，表示盈利达到多少时开始跟踪
  - 例如：0.05 表示盈利达到5%时开始启用移动止盈
  - 取值范围：0 到 1（0.05 = 5%）

**工作原理：**

1. 持仓盈利达到 `trailing_stop_activation`（如5%）时，系统激活移动止盈并开始跟踪最高盈利点
2. **一旦激活，就会持续跟踪**，即使盈利回撤到激活条件以下也继续监控
3. 当盈利从峰值回撤超过 `trailing_stop_distance`（如3%）时，自动全部平仓
4. 例如：盈利达到10%（峰值），然后回落到7%时触发止盈（10% - 7% = 3%回撤）

**重要特性：**
- 移动止盈一旦激活就不会取消，即使盈利大幅回撤也会继续跟踪
- 这样可以防止"盈利变亏损"的情况发生

### 分仓止盈配置

```json
{
  "enable_partial_take_profit": true
}
```

**参数说明：**

- `enable_partial_take_profit`：是否启用分仓止盈（true/false）

**工作原理：**

分仓止盈基于AI给出的止盈价格自动计算两个档位：

1. **50%目标**：当价格达到（开仓价 → 止盈价）的50%时，平仓50%的持仓
2. **100%目标**：当价格达到AI设置的止盈价时，平仓剩余50%的持仓

**示例：**

假设AI开多仓：
- 开仓价：100 USDT
- 止盈价：110 USDT（AI设定）
- 50%目标价：105 USDT（自动计算）
- 100%目标价：110 USDT

执行流程：
1. 价格涨到105时，自动平仓50%
2. 价格涨到110时，自动平仓剩余50%

假设AI开空仓：
- 开仓价：100 USDT
- 止盈价：90 USDT（AI设定）
- 50%目标价：95 USDT（自动计算）
- 100%目标价：90 USDT

执行流程：
1. 价格跌到95时，自动平仓50%
2. 价格跌到90时，自动平仓剩余50%

## 配置示例

### 示例1：保守型配置

适合稳健交易者，快速锁定利润：

```json
{
  "enable_trailing_stop": true,
  "trailing_stop_distance": 0.02,
  "trailing_stop_activation": 0.03,
  "enable_partial_take_profit": true
}
```

- 盈利3%时启动移动止盈，回撤2%就平仓
- 达到AI止盈目标的50%时先平50%，达到100%时平剩余50%

### 示例2：激进型配置

适合追求高收益的交易者：

```json
{
  "enable_trailing_stop": true,
  "trailing_stop_distance": 0.05,
  "trailing_stop_activation": 0.10,
  "enable_partial_take_profit": true
}
```

- 盈利10%时启动移动止盈，回撤5%才平仓
- 达到AI止盈目标的50%时先平50%，达到100%时平剩余50%

### 示例3：仅使用移动止盈

```json
{
  "enable_trailing_stop": true,
  "trailing_stop_distance": 0.03,
  "trailing_stop_activation": 0.05,
  "enable_partial_take_profit": false
}
```

### 示例4：仅使用分仓止盈

```json
{
  "enable_trailing_stop": false,
  "enable_partial_take_profit": true
}
```

## 注意事项

1. **两种策略可以同时使用**：分仓止盈会先执行，移动止盈会在剩余仓位上生效
2. **分仓止盈基于AI决策**：止盈目标由AI根据市场分析给出，系统自动计算50%和100%档位
3. **交易所止盈单管理**：启用分仓止盈后，系统不会在交易所设置止盈单，而是由程序自动管理
4. **配置验证**：系统启动时会自动验证配置参数的有效性
5. **执行优先级**：止盈检查在AI决策之前执行，确保及时锁定利润
6. **日志记录**：所有止盈操作都会记录在决策日志中，便于回溯分析
7. **数据同步**：执行止盈操作后，系统会自动重新获取最新持仓数据，确保AI看到的是最新状态
8. **延迟处理**：止盈执行后会等待2秒，确保交易所数据更新完成

## 完整配置示例

参考 `config.json.trailing_stop_example` 文件查看完整配置示例。

## 禁用止盈功能

如果不需要自动止盈，可以将两个开关都设置为 false：

```json
{
  "enable_trailing_stop": false,
  "enable_partial_take_profit": false
}
```

这样系统将完全依赖AI的决策进行平仓操作。


## 技术实现细节

### 执行流程

每个交易周期的执行顺序如下：

1. **获取账户和持仓数据**：从交易所获取最新的账户余额和持仓信息
2. **检查止盈条件**：
   - 遍历所有持仓，检查是否满足移动止盈或分仓止盈条件
   - 如果满足条件，立即执行平仓操作
3. **更新持仓数据**（如果执行了止盈）：
   - 等待2秒让交易所更新数据
   - 重新获取最新的账户和持仓信息
4. **AI决策**：将最新的持仓数据发送给AI进行分析和决策
5. **执行AI决策**：按照AI的决策执行开仓/平仓操作

### 数据跟踪

系统为每个持仓维护以下跟踪数据：

- **最大盈利百分比**：持仓期间达到的最高盈利点（用于移动止盈）
- **最大亏损百分比**：持仓期间达到的最大亏损点
- **移动止盈激活状态**：是否已激活移动止盈（一旦激活就持续跟踪）
- **止盈价格**：AI设置的止盈目标价格
- **开仓价格**：实际开仓价格
- **50%止盈执行状态**：是否已执行50%档位的分仓止盈
- **100%止盈执行状态**：是否已执行100%档位的分仓止盈

### 关键优化

1. **避免数据不一致**：执行止盈后重新获取持仓数据，确保AI看到的是最新状态
2. **防止重复执行**：每个分仓止盈档位只会触发一次
3. **持仓清理**：当持仓完全平仓后，自动清理相关的跟踪数据
4. **并发安全**：使用map存储跟踪数据，确保多持仓场景下的数据正确性

## 监控和调试

### 日志输出

系统会输出详细的止盈日志，例如：

```
✨ [移动止盈激活] BTCUSDT long: 盈利5.20% 达到激活条件5.00%, 开始跟踪峰值
🎯 [移动止盈] BTCUSDT long: 盈利8.50% (峰值10.20%), 回撤1.70% >= 3.00%, 触发移动止盈
✓ 移动止盈平仓成功
🔄 止盈操作已执行，重新获取最新持仓数据...
📊 更新后账户净值: 105.50 USDT | 可用: 105.50 USDT | 持仓: 0
```

```
🎯 [分仓止盈50%] ETHUSDT short: 当前价95.00 达到50%目标95.00, 平仓50%
✓ 分仓止盈50%成功
🎯 [分仓止盈100%] ETHUSDT short: 当前价90.00 达到100%目标90.00, 平仓剩余50%
✓ 分仓止盈100%成功
```

### 决策日志

所有止盈操作都会记录在 `decision_logs/{trader_id}/` 目录下，包含：

- 操作类型：`trailing_stop_long`、`trailing_stop_short`、`partial_tp_long`、`partial_tp_short`
- 执行时间、价格、数量
- 成功/失败状态和错误信息

## 常见问题

### Q: 移动止盈和分仓止盈会冲突吗？

A: 不会。两者可以同时使用：
- 分仓止盈会在达到指定盈利水平时分批平仓
- 移动止盈会在剩余仓位上继续跟踪，当回撤达到设定距离时平掉剩余仓位

### Q: 移动止盈激活后，如果盈利回撤到激活条件以下会怎样？

A: 移动止盈一旦激活就会持续跟踪，不会因为盈利回撤而取消。例如：激活条件是5%，盈利达到10%后激活，即使回撤到3%，移动止盈仍然有效，会继续跟踪峰值（10%）并在回撤超过设定距离时触发。

### Q: 如果止盈执行失败会怎样？

A: 系统会记录错误日志，但不会中断交易流程。下个周期会继续检查止盈条件。

### Q: 止盈操作会影响AI的决策吗？

A: 不会。止盈操作在AI决策之前执行，且执行后会更新持仓数据，AI看到的始终是最新状态。

### Q: 分仓止盈的目标价格是如何确定的？

A: 分仓止盈的目标价格由AI在开仓时根据市场分析自动设定。系统会基于这个目标价格自动计算50%和100%两个档位。

### Q: 可以为不同币种设置不同的止盈参数吗？

A: 移动止盈参数是全局的，应用于该trader的所有持仓。分仓止盈的目标价格由AI为每个持仓单独设定。如需完全不同的策略，可以创建多个trader实例。

### Q: 止盈检查的频率是多少？

A: 止盈检查在每个交易周期执行，频率由 `scan_interval_minutes` 参数决定（如5分钟一次）。
