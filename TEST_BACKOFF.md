# 幂级避让功能测试指南

## 测试准备

### 1. 配置文件

使用 `config.json.backoff_example` 作为模板，或在现有配置中添加：

```json
{
  "enable_exponential_backoff": true,
  "backoff_base_minutes": 5,
  "backoff_multiplier": 2.0,
  "backoff_max_minutes": 20,
  "backoff_reset_hours": 1
}
```

**注意**：测试时使用较短的时间，方便观察效果。

### 2. 启动系统

```bash
go run main.go
```

## 测试场景

### 场景1：第一次止损

**预期行为**：
1. 开仓后触发止损
2. 系统检测到止损（价格接近止损价 + 账户总额减少）
3. 暂停交易5分钟
4. 日志输出：
```
🛑 检测到止损触发（第1次）：BTCUSDT_long
   止损价: 95000.0000 | 当前价: 94800.0000 | 入场价: 96000.0000
   账户总额: 1000.00 -> 985.50 (-14.50)
⏸ 幂级避让启动：暂停交易5分钟（至15:35:00）
```

### 场景2：第二次止损

**预期行为**：
1. 5分钟后恢复交易
2. 再次触发止损
3. 暂停交易10分钟（5 × 2.0）
4. 日志输出：
```
🛑 检测到止损触发（第2次）：ETHUSDT_short
   止损价: 3500.0000 | 当前价: 3520.0000 | 入场价: 3450.0000
   账户总额: 985.50 -> 972.30 (-13.20)
⏸ 幂级避让启动：暂停交易10分钟（至15:50:00）
```

### 场景3：达到最大时间

**预期行为**：
1. 继续触发止损
2. 暂停时间达到上限（20分钟）
3. 不再继续增长

### 场景4：计数器重置

**预期行为**：
1. 距离上次止损超过1小时
2. 计数器自动重置为0
3. 日志输出：
```
✅ 幂级避让：距离上次止损已超过1小时，重置计数器（2 -> 0）
```

## 验证要点

### 1. 止损检测准确性

检查日志中的信息：
- 止损价格是否正确记录
- 当前价格是否接近止损价
- 是否在±5%容差范围内
- 账户总额是否减少（确认是亏损）

### 2. 暂停时间计算

验证公式：`休息时间 = 基础时间 × (倍数 ^ (次数 - 1))`

示例（基础5分钟，倍数2.0）：
- 第1次：5分钟
- 第2次：10分钟
- 第3次：20分钟（达到上限）

### 3. 暂停期间行为

- ✅ 不会开新仓
- ✅ 现有持仓继续保留
- ✅ 每个周期输出暂停提示

### 4. 计数器重置

- 距离上次止损超过设定时间
- 计数器归零
- 下次止损从第1次开始

## 调试技巧

### 查看详细日志

系统会输出详细的检测信息：
```
🛑 检测到止损触发（第X次）：SYMBOL_SIDE
   止损价: XXXX | 当前价: XXXX | 入场价: XXXX
⏸ 幂级避让启动：暂停交易XX分钟（至HH:MM:SS）
```

### 检查持仓跟踪

在 `checkStopLossTriggered()` 方法中添加调试日志：
```go
log.Printf("检查持仓: %s, 止损价: %.4f", posKey, tracking.StopLossPrice)
```

### 验证价格比对

确认价格比对逻辑：
```go
// 多仓
if currentPrice <= stopLossPrice*1.05 {
    log.Printf("多仓止损触发: 当前%.4f <= 止损%.4f*1.05", currentPrice, stopLossPrice)
}

// 空仓
if currentPrice >= stopLossPrice*0.95 {
    log.Printf("空仓止损触发: 当前%.4f >= 止损%.4f*0.95", currentPrice, stopLossPrice)
}
```

## 常见问题

### Q1: 止损没有被检测到

**可能原因**：
- 价格偏差超过5%
- 止损价格没有正确记录
- 持仓消失时机不对

**解决方法**：
- 检查日志中的价格信息
- 确认开仓时是否初始化了 `PnLTracking`
- 增加调试日志

### Q2: 止盈也触发了避让

**可能原因**：
- 价格判断逻辑有误

**解决方法**：
- 检查价格比对条件
- 确认是止损还是止盈

### Q3: 暂停时间不正确

**可能原因**：
- 配置参数错误
- 计算公式有误

**解决方法**：
- 检查配置文件
- 验证计算逻辑

## 生产环境配置

测试通过后，调整为生产环境参数：

```json
{
  "enable_exponential_backoff": true,
  "backoff_base_minutes": 45,
  "backoff_multiplier": 2.67,
  "backoff_max_minutes": 360,
  "backoff_reset_hours": 24
}
```

## 监控建议

1. **定期检查日志**：确认止损检测是否正常
2. **统计触发次数**：分析止损频率
3. **评估效果**：对比启用前后的交易表现
4. **调整参数**：根据实际情况优化配置
