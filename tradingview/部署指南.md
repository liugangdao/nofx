# 部署指南

本文档介绍如何在生产环境中部署 TradingView Webhook 服务。

## 快速部署（使用 nohup）

### 1. 准备文件

```bash
# 上传文件到服务器
scp -r tradingview/ user@your-server:/path/to/

# 或使用 git
git clone your-repo
cd tradingview
```

### 2. 配置

```bash
# 复制配置文件
cp tradingview_config.json.example tradingview_config.json

# 编辑配置
nano tradingview_config.json
```

### 3. 添加执行权限

```bash
chmod +x start.sh stop.sh restart.sh status.sh logs.sh
```

### 4. 启动服务

```bash
./start.sh
```

### 5. 检查状态

```bash
./status.sh
```

## 管理脚本

### start.sh - 启动服务

```bash
./start.sh
```

**功能：**
- 检查配置文件
- 自动编译（如果需要）
- 使用 nohup 后台启动
- 保存 PID 到文件
- 显示启动日志

### stop.sh - 停止服务

```bash
./stop.sh
```

**功能：**
- 优雅停止进程
- 如果无响应则强制终止
- 清理 PID 文件

### restart.sh - 重启服务

```bash
./restart.sh
```

**功能：**
- 先停止服务
- 等待 2 秒
- 重新启动服务

### status.sh - 查看状态

```bash
./status.sh
```

**功能：**
- 显示进程信息
- 显示端口监听
- 显示最新日志
- 显示常用命令

### logs.sh - 查看日志

```bash
# 实时查看日志
./logs.sh -f

# 查看最后 100 行
./logs.sh -n 100

# 只看错误
./logs.sh -e

# 只看成功
./logs.sh -s

# 清空日志
./logs.sh -c
```

## 日志管理

### 日志文件

- 位置：`tradingview_webhook.log`
- 包含：所有输出（stdout 和 stderr）

### 查看实时日志

```bash
tail -f tradingview_webhook.log
```

### 日志轮转（推荐）

创建 logrotate 配置 `/etc/logrotate.d/tradingview-webhook`：

```
/path/to/tradingview/tradingview_webhook.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    create 0644 user user
    postrotate
        # 可选：重启服务以使用新日志文件
        # /path/to/tradingview/restart.sh > /dev/null 2>&1
    endscript
}
```

测试配置：
```bash
sudo logrotate -d /etc/logrotate.d/tradingview-webhook
```

## 使用 systemd（推荐用于生产环境）

### 1. 创建 systemd 服务文件

创建 `/etc/systemd/system/tradingview-webhook.service`：

```ini
[Unit]
Description=TradingView Webhook Service
After=network.target

[Service]
Type=simple
User=your_user
Group=your_group
WorkingDirectory=/path/to/tradingview
ExecStart=/path/to/tradingview/tradingview_webhook -config /path/to/tradingview/tradingview_config.json
Restart=always
RestartSec=10
StandardOutput=append:/path/to/tradingview/tradingview_webhook.log
StandardError=append:/path/to/tradingview/tradingview_webhook.log

# 安全设置
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ProtectHome=true
ReadWritePaths=/path/to/tradingview

[Install]
WantedBy=multi-user.target
```

### 2. 启用并启动服务

```bash
# 重载 systemd 配置
sudo systemctl daemon-reload

# 启用开机自启
sudo systemctl enable tradingview-webhook

# 启动服务
sudo systemctl start tradingview-webhook

# 查看状态
sudo systemctl status tradingview-webhook

# 查看日志
sudo journalctl -u tradingview-webhook -f
```

### 3. 管理服务

```bash
# 停止服务
sudo systemctl stop tradingview-webhook

# 重启服务
sudo systemctl restart tradingview-webhook

# 重新加载配置
sudo systemctl reload tradingview-webhook

# 查看日志
sudo journalctl -u tradingview-webhook -n 100
```

## 使用 Docker（可选）

### 1. 创建 Dockerfile

```dockerfile
FROM golang:1.21-alpine AS builder

WORKDIR /app
COPY . .
RUN go build -o tradingview_webhook main.go

FROM alpine:latest

RUN apk --no-cache add ca-certificates tzdata
WORKDIR /root/

COPY --from=builder /app/tradingview_webhook .
COPY tradingview_config.json .

EXPOSE 9090

CMD ["./tradingview_webhook", "-config", "tradingview_config.json"]
```

### 2. 构建镜像

```bash
docker build -t tradingview-webhook .
```

### 3. 运行容器

```bash
docker run -d \
  --name tradingview-webhook \
  -p 9090:9090 \
  -v $(pwd)/tradingview_config.json:/root/tradingview_config.json \
  --restart unless-stopped \
  tradingview-webhook
```

### 4. 管理容器

```bash
# 查看日志
docker logs -f tradingview-webhook

# 停止容器
docker stop tradingview-webhook

# 启动容器
docker start tradingview-webhook

# 重启容器
docker restart tradingview-webhook
```

## 使用 Docker Compose

### docker-compose.yml

```yaml
version: '3.8'

services:
  tradingview-webhook:
    build: .
    container_name: tradingview-webhook
    ports:
      - "9090:9090"
    volumes:
      - ./tradingview_config.json:/root/tradingview_config.json:ro
      - ./logs:/root/logs
    restart: unless-stopped
    environment:
      - TZ=Asia/Shanghai
```

### 管理

```bash
# 启动
docker-compose up -d

# 查看日志
docker-compose logs -f

# 停止
docker-compose down

# 重启
docker-compose restart
```

## 监控和告警

### 1. 健康检查脚本

创建 `health_check.sh`：

```bash
#!/bin/bash

WEBHOOK_URL="http://localhost:9090/health"
ALERT_EMAIL="your@email.com"

response=$(curl -s -o /dev/null -w "%{http_code}" "$WEBHOOK_URL")

if [ "$response" != "200" ]; then
    echo "TradingView Webhook 服务异常！HTTP 状态码: $response" | \
        mail -s "TradingView Webhook 告警" "$ALERT_EMAIL"
    
    # 尝试重启服务
    /path/to/tradingview/restart.sh
fi
```

### 2. 添加到 crontab

```bash
# 每 5 分钟检查一次
*/5 * * * * /path/to/health_check.sh
```

### 3. 使用 Prometheus + Grafana（高级）

可以添加 Prometheus metrics 端点来监控：
- 请求数量
- 响应时间
- 错误率
- 活跃连接数

## 性能优化

### 1. 编译优化

```bash
# 使用优化标志编译
go build -ldflags="-s -w" -o tradingview_webhook main.go

# 进一步压缩（可选）
upx tradingview_webhook
```

### 2. 系统优化

```bash
# 增加文件描述符限制
ulimit -n 65535

# 或在 /etc/security/limits.conf 中添加：
# your_user soft nofile 65535
# your_user hard nofile 65535
```

### 3. 使用反向代理

使用 Nginx 作为反向代理可以：
- 提供 SSL/TLS 加密
- 负载均衡
- 请求限流
- 缓存静态内容

## 备份和恢复

### 备份配置

```bash
# 备份配置文件
cp tradingview_config.json tradingview_config.json.backup

# 或使用 git
git add tradingview_config.json
git commit -m "Backup config"
```

### 备份日志

```bash
# 压缩并备份日志
tar -czf logs_backup_$(date +%Y%m%d).tar.gz tradingview_webhook.log
```

## 故障排查

### 服务无法启动

1. 检查配置文件
2. 检查端口是否被占用：`netstat -tlnp | grep 9090`
3. 查看日志：`./logs.sh -e`
4. 检查权限：`ls -la tradingview_webhook`

### 服务频繁重启

1. 查看日志找出原因
2. 检查系统资源（内存、CPU）
3. 检查网络连接
4. 验证 Hyperliquid API 连接

### 内存泄漏

```bash
# 监控内存使用
watch -n 5 'ps aux | grep tradingview_webhook'

# 如果发现内存持续增长，考虑定期重启
# 在 crontab 中添加：
# 0 3 * * * /path/to/tradingview/restart.sh
```

## 安全检查清单

- [ ] 配置文件权限正确（600 或 400）
- [ ] 使用 webhook_secret 验证请求
- [ ] 配置防火墙规则
- [ ] 使用 HTTPS（通过 Nginx）
- [ ] 限制访问 IP（可选）
- [ ] 定期更新依赖
- [ ] 定期备份配置
- [ ] 监控异常活动
- [ ] 使用非 root 用户运行

## 更新部署

### 1. 备份当前版本

```bash
./stop.sh
cp tradingview_webhook tradingview_webhook.backup
cp tradingview_config.json tradingview_config.json.backup
```

### 2. 更新代码

```bash
git pull
# 或上传新文件
```

### 3. 重新编译

```bash
go build -o tradingview_webhook main.go
```

### 4. 重启服务

```bash
./start.sh
```

### 5. 验证

```bash
./status.sh
curl http://localhost:9090/health
```

## 相关文档

- [快速开始指南](QUICK_START.zh-CN.md)
- [网络配置指南](网络配置指南.md)
- [测试指南](测试指南.md)
