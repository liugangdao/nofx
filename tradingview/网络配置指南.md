# 网络配置指南

本指南介绍如何配置网络，让 TradingView Webhook 服务器可以从外部访问。

## 服务器监听地址

服务器已配置为监听 `0.0.0.0`，这意味着：
- ✅ 可以从本地访问（localhost）
- ✅ 可以从局域网访问（内网 IP）
- ✅ 可以从互联网访问（公网 IP，需要配置防火墙）

## 访问方式

### 1. 本地访问

```bash
curl http://localhost:9090/health
```

### 2. 局域网访问

```bash
# 假设服务器内网 IP 是 192.168.1.100
curl http://192.168.1.100:9090/health
```

### 3. 公网访问

```bash
# 假设服务器公网 IP 是 123.45.67.89
curl http://123.45.67.89:9090/health
```

## 防火墙配置

### Linux (UFW)

```bash
# 允许 9090 端口
sudo ufw allow 9090/tcp

# 查看状态
sudo ufw status
```

### Linux (firewalld)

```bash
# 允许 9090 端口
sudo firewall-cmd --permanent --add-port=9090/tcp
sudo firewall-cmd --reload

# 查看状态
sudo firewall-cmd --list-ports
```

### Windows 防火墙

#### 方法 1: 使用 PowerShell（管理员权限）

```powershell
New-NetFirewallRule -DisplayName "TradingView Webhook" `
  -Direction Inbound `
  -LocalPort 9090 `
  -Protocol TCP `
  -Action Allow
```

#### 方法 2: 使用图形界面

1. 打开"Windows Defender 防火墙"
2. 点击"高级设置"
3. 选择"入站规则" → "新建规则"
4. 选择"端口" → 下一步
5. 选择"TCP"，输入端口 `9090` → 下一步
6. 选择"允许连接" → 下一步
7. 选择应用的网络类型 → 下一步
8. 输入名称"TradingView Webhook" → 完成

### 云服务器安全组

#### AWS EC2

1. 进入 EC2 控制台
2. 选择实例 → 安全组
3. 编辑入站规则
4. 添加规则：
   - 类型：自定义 TCP
   - 端口：9090
   - 源：0.0.0.0/0（所有 IP）或指定 IP

#### 阿里云 ECS

1. 进入 ECS 控制台
2. 选择实例 → 安全组配置
3. 添加安全组规则：
   - 规则方向：入方向
   - 协议类型：TCP
   - 端口范围：9090/9090
   - 授权对象：0.0.0.0/0

#### 腾讯云 CVM

1. 进入 CVM 控制台
2. 选择实例 → 安全组
3. 添加入站规则：
   - 类型：自定义
   - 协议端口：TCP:9090
   - 来源：0.0.0.0/0

## 获取服务器 IP

### 查看内网 IP

#### Linux/Mac

```bash
# 方法 1
ifconfig

# 方法 2
ip addr show

# 方法 3
hostname -I
```

#### Windows

```cmd
ipconfig
```

### 查看公网 IP

```bash
# 方法 1
curl ifconfig.me

# 方法 2
curl ipinfo.io/ip

# 方法 3
curl icanhazip.com
```

## 测试外部访问

### 从另一台机器测试

```bash
# 替换为你的服务器 IP
curl http://YOUR_SERVER_IP:9090/health
```

### 使用在线工具测试

1. 访问 https://reqbin.com/
2. 输入 URL：`http://YOUR_SERVER_IP:9090/health`
3. 点击 Send

## TradingView 配置

### Webhook URL 格式

```
http://YOUR_SERVER_IP:9090/webhook
```

**示例：**
- 公网 IP：`http://123.45.67.89:9090/webhook`
- 域名：`http://trading.example.com:9090/webhook`
- HTTPS（推荐）：`https://trading.example.com/webhook`

### Alert Message

```json
{
  "action": "buy",
  "symbol": "{{ticker}}"
}
```

## 使用域名（推荐）

### 1. 配置 DNS

在域名服务商添加 A 记录：
```
trading.example.com  →  123.45.67.89
```

### 2. 配置 Nginx 反向代理

安装 Nginx：
```bash
# Ubuntu/Debian
sudo apt install nginx

# CentOS/RHEL
sudo yum install nginx
```

创建配置文件 `/etc/nginx/sites-available/tradingview-webhook`：

```nginx
server {
    listen 80;
    server_name trading.example.com;

    location /webhook {
        proxy_pass http://127.0.0.1:9090;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /health {
        proxy_pass http://127.0.0.1:9090;
    }
}
```

启用配置：
```bash
sudo ln -s /etc/nginx/sites-available/tradingview-webhook /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

### 3. 配置 SSL/HTTPS（强烈推荐）

使用 Let's Encrypt 免费证书：

```bash
# 安装 Certbot
sudo apt install certbot python3-certbot-nginx

# 获取证书并自动配置 Nginx
sudo certbot --nginx -d trading.example.com

# 测试自动续期
sudo certbot renew --dry-run
```

Nginx 配置会自动更新为：

```nginx
server {
    listen 443 ssl;
    server_name trading.example.com;

    ssl_certificate /etc/letsencrypt/live/trading.example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/trading.example.com/privkey.pem;

    location /webhook {
        proxy_pass http://127.0.0.1:9090;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 如果配置了 webhook_secret，可以在这里添加
        # proxy_set_header X-Webhook-Secret "your_secret_key";
    }
}

server {
    listen 80;
    server_name trading.example.com;
    return 301 https://$server_name$request_uri;
}
```

## 安全建议

### 1. 使用 Webhook 密钥

在配置文件中设置：
```json
{
  "webhook_secret": "your_very_long_random_secret_key"
}
```

### 2. 限制访问 IP（可选）

#### Nginx 配置

```nginx
location /webhook {
    # 只允许 TradingView 的 IP 访问
    allow 52.89.214.238;
    allow 34.212.75.30;
    allow 54.218.53.128;
    allow 52.32.178.7;
    deny all;

    proxy_pass http://127.0.0.1:9090;
}
```

#### 防火墙配置

```bash
# UFW 示例：只允许特定 IP
sudo ufw allow from 52.89.214.238 to any port 9090
sudo ufw allow from 34.212.75.30 to any port 9090
```

### 3. 使用 HTTPS

- 保护数据传输安全
- 防止中间人攻击
- TradingView 推荐使用 HTTPS

### 4. 监控和日志

#### 启用访问日志

服务器会自动记录所有请求，检查日志：
```bash
# 查看实时日志
tail -f /path/to/log/file

# 或者查看服务器输出
journalctl -u tradingview-webhook -f
```

#### 设置告警

使用监控工具（如 Prometheus + Grafana）监控：
- 请求频率
- 错误率
- 响应时间
- 服务器资源使用

## 故障排查

### 问题 1: 无法从外部访问

**检查清单：**
1. ✅ 服务器正在运行
2. ✅ 监听 0.0.0.0（不是 127.0.0.1）
3. ✅ 防火墙已开放端口
4. ✅ 云服务器安全组已配置
5. ✅ 路由器端口转发已配置（如果在家庭网络）

**测试命令：**
```bash
# 在服务器上测试
curl http://localhost:9090/health

# 在服务器上测试内网 IP
curl http://$(hostname -I | awk '{print $1}'):9090/health

# 从外部测试
curl http://YOUR_PUBLIC_IP:9090/health
```

### 问题 2: TradingView 无法连接

**可能原因：**
1. URL 格式错误
2. 端口被防火墙阻止
3. 服务器未运行
4. Webhook 密钥不匹配

**解决方法：**
1. 使用在线工具测试 URL
2. 检查防火墙和安全组
3. 查看服务器日志
4. 临时移除 webhook_secret 测试

### 问题 3: 连接超时

**可能原因：**
1. 网络问题
2. 服务器负载过高
3. 防火墙规则问题

**解决方法：**
```bash
# 检查端口是否开放
telnet YOUR_SERVER_IP 9090

# 或使用 nc
nc -zv YOUR_SERVER_IP 9090

# 检查服务器监听
netstat -tlnp | grep 9090
```

## 性能优化

### 1. 使用 CDN（可选）

如果使用域名，可以配置 CDN 加速：
- Cloudflare
- AWS CloudFront
- 阿里云 CDN

### 2. 负载均衡（高级）

如果流量很大，可以部署多个实例：

```nginx
upstream tradingview_backend {
    server 127.0.0.1:9090;
    server 127.0.0.1:9091;
    server 127.0.0.1:9092;
}

server {
    location /webhook {
        proxy_pass http://tradingview_backend;
    }
}
```

## 测试清单

- [ ] 本地访问正常（localhost）
- [ ] 内网访问正常（局域网 IP）
- [ ] 公网访问正常（公网 IP）
- [ ] 防火墙已配置
- [ ] 云服务器安全组已配置
- [ ] 域名解析正常（如果使用）
- [ ] SSL 证书有效（如果使用 HTTPS）
- [ ] TradingView 可以连接
- [ ] Webhook 密钥验证正常

## 相关文档

- [快速开始指南](QUICK_START.zh-CN.md)
- [测试指南](测试指南.md)
- [Curl 命令示例](CURL_EXAMPLES.md)
