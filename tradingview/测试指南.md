# 测试指南

本文档介绍如何测试 TradingView Webhook 服务器。

## 测试前准备

### 1. 启动服务器

```bash
# 方法 1: 直接运行
go run main.go -config tradingview_config.json

# 方法 2: 编译后运行
go build -o tradingview_webhook main.go
./tradingview_webhook -config tradingview_config.json

# Windows
tradingview_webhook.exe -config tradingview_config.json
```

### 2. 确认服务器运行

打开浏览器访问：http://localhost:9090/health

应该看到：
```json
{
  "status": "ok"
}
```

## 测试方法

### 方法 1: 使用测试脚本（推荐）

#### Linux/Mac

```bash
# 添加执行权限
chmod +x test_curl.sh

# 运行测试
./test_curl.sh
```

#### Windows PowerShell

```powershell
.\test_webhook.ps1
```

#### Windows CMD

```cmd
test_curl.bat
```

### 方法 2: 手动 curl 命令

#### 测试开多仓

```bash
curl -X POST http://localhost:9090/webhook \
  -H "Content-Type: application/json" \
  -d '{
    "action": "buy",
    "symbol": "BTC"
  }'
```

#### 测试平多仓

```bash
curl -X POST http://localhost:9090/webhook \
  -H "Content-Type: application/json" \
  -d '{
    "action": "close_long",
    "symbol": "BTC"
  }'
```

更多示例请查看 [CURL_EXAMPLES.md](CURL_EXAMPLES.md)

### 方法 3: 使用 Postman

1. 创建新请求
2. 方法：POST
3. URL：`http://localhost:9090/webhook`
4. Headers：
   - `Content-Type`: `application/json`
   - `X-Webhook-Secret`: `your_secret_key`（如果配置了）
5. Body（raw JSON）：
```json
{
  "action": "buy",
  "symbol": "BTC"
}
```

## 测试场景

### 场景 1: 基础功能测试

1. ✅ 健康检查
2. ✅ 开多仓（使用默认参数）
3. ✅ 平多仓
4. ✅ 开空仓（指定杠杆）
5. ✅ 平空仓

### 场景 2: 仓位保护测试

1. ✅ 开多仓（BTC）
2. ✅ 尝试再次开多仓（应该被跳过）
3. ✅ 平多仓
4. ✅ 确认可以再次开仓

### 场景 3: 资金管理测试

1. ✅ 配置 `position_size_percent: 5.0`
2. ✅ 开仓（不指定数量）
3. ✅ 检查日志，确认使用了账户资金的 5%
4. ✅ 修改为 `position_size_percent: 10.0`
5. ✅ 再次开仓，确认使用了 10%

### 场景 4: 多币种测试

1. ✅ 同时开多个币种的仓位
2. ✅ 确认每个币种独立管理
3. ✅ 分别平仓

### 场景 5: 错误处理测试

1. ✅ 发送无效的 action
2. ✅ 发送缺少字段的请求
3. ✅ 使用错误的 webhook_secret
4. ✅ 确认返回正确的错误信息

## 预期结果

### 成功的开仓响应

```json
{
  "action": "buy",
  "symbol": "BTCUSDT",
  "quantity": 0.001,
  "price": 45123.45,
  "leverage": 5,
  "status": "success"
}
```

### 仓位保护响应

```json
{
  "action": "buy",
  "symbol": "BTCUSDT",
  "status": "skipped",
  "reason": "已有long仓位",
  "message": "BTCUSDT 已有 long 仓位，跳过开多仓"
}
```

### 错误响应

```json
{
  "error": "未知的操作: invalid_action"
}
```

## 日志检查

### 正常开仓日志

```
📨 收到TradingView信号: {action:buy symbol:BTC quantity:0 leverage:0}
💰 自动计算数量: 0.00111111 (账户资金的 5.0%)
📊 账户净值: 1000.00 USDT
📊 下单金额: 50.00 USDT (5.0%)
📊 当前价格: 45000.00 USDT
📊 计算数量: 0.00111111
📈 开多仓: BTCUSDT 数量: 0.0011 杠杆: 5x
  ✓ BTCUSDT 杠杆已设置为 5x
  📏 数量: 0.00111111 -> 0.00111111
  💰 价格: 45450.00000000 -> 45450.00000000
✓ 开多仓成功: BTCUSDT 数量: 0.0011
✓ 信号处理成功: map[action:buy leverage:5 price:45450 quantity:0.00111111 status:success symbol:BTCUSDT]
```

### 仓位保护日志

```
📨 收到TradingView信号: {action:buy symbol:BTC quantity:0 leverage:0}
📈 开多仓: BTCUSDT 数量: 0.0000 杠杆: 5x
  ⚠️ BTCUSDT 已有 long 仓位，跳过开仓
✓ 信号处理成功: map[action:buy message:BTCUSDT 已有 long 仓位，跳过开多仓 reason:已有long仓位 status:skipped symbol:BTCUSDT]
```

## 故障排查

### 问题 1: 连接失败

**症状：** `curl: (7) Failed to connect to localhost port 9090`

**解决：**
1. 确认服务器正在运行
2. 检查端口是否被占用：`netstat -an | grep 9090`
3. 检查防火墙设置

### 问题 2: Webhook 密钥错误

**症状：** `{"error":"无效的webhook密钥"}`

**解决：**
1. 检查配置文件中的 `webhook_secret`
2. 确认 curl 命令中的 `X-Webhook-Secret` Header
3. 如果不需要验证，将配置文件中的 `webhook_secret` 设为空字符串

### 问题 3: 下单失败

**症状：** `{"error":"开多仓失败: ..."}`

**解决：**
1. 检查账户余额是否充足
2. 确认私钥和钱包地址正确
3. 检查网络连接
4. 查看服务器日志获取详细错误信息

### 问题 4: 数量太小

**症状：** 订单被拒绝，提示数量太小

**解决：**
1. 增加 `position_size_percent`（如从 5% 改为 10%）
2. 或使用固定数量模式，设置合适的 `default_quantity`
3. 检查交易所的最小下单量要求

## 性能测试

### 测试响应时间

```bash
for i in {1..10}; do
  echo "Test $i:"
  curl -w "Time: %{time_total}s\n" \
    -X POST http://localhost:9090/webhook \
    -H "Content-Type: application/json" \
    -d '{"action":"buy","symbol":"BTC"}' \
    -o /dev/null -s
  sleep 1
done
```

### 测试并发请求

```bash
# 使用 Apache Bench
ab -n 100 -c 10 -p signal.json -T application/json \
  http://localhost:9090/webhook
```

## 测试清单

- [ ] 健康检查正常
- [ ] 开多仓成功
- [ ] 开空仓成功
- [ ] 平多仓成功
- [ ] 平空仓成功
- [ ] 仓位保护生效
- [ ] 资金百分比计算正确
- [ ] 杠杆设置正确
- [ ] 错误处理正确
- [ ] 日志输出完整
- [ ] Webhook 密钥验证正常（如果配置了）

## 下一步

测试通过后，可以：

1. 在 TradingView 中配置真实的 Alert
2. 部署到生产服务器
3. 配置 HTTPS 和域名
4. 设置监控和告警

## 相关文档

- [快速开始指南](QUICK_START.zh-CN.md)
- [Curl 命令示例](CURL_EXAMPLES.md)
- [使用示例](EXAMPLES.md)
- [更新说明](更新说明.md)
